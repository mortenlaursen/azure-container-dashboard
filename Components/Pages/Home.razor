@page "/"
@rendermode InteractiveServer
@inject ContainerAppFunctionsClient Client

<PageTitle>Container App Functions</PageTitle>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 text-gray-200">
    <header class="mb-10">
        <h1 class="text-3xl font-bold tracking-tight text-gray-100 sm:text-4xl">Container App Functions</h1>
        <p class="mt-2 text-lg text-gray-400">A simple dashboard to manage your Azure Container App Functions.</p>
    </header>

    <div style="background-color: #272941; border: 1px solid #363960; border-radius: 12px; padding: 28px; margin-bottom: 32px; box-shadow: 0 4px 24px rgba(0,0,0,0.2);">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
            <div>
                <label for="sub" class="block text-sm font-medium text-gray-300 mb-2">Subscription ID</label>
                <input id="sub" @bind="subscriptionId" class="form-input" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"/>
            </div>
            <div>
                <label for="rg" class="block text-sm font-medium text-gray-300 mb-2">Resource Group</label>
                <input id="rg" @bind="resourceGroup" class="form-input" placeholder="my-resource-group"/>
            </div>
            <div>
                <label for="app" class="block text-sm font-medium text-gray-300 mb-2">Container App Name</label>
                <input id="app" @bind="appName" class="form-input" placeholder="my-container-app"/>
            </div>
            <div>
                <label for="rev" class="block text-sm font-medium text-gray-300 mb-2">Revision <span class="text-gray-500">(optional)</span></label>
                <input id="rev" @bind="revision" class="form-input" placeholder="Leave empty for latest"/>
            </div>
        </div>
        <div class="flex items-center mt-8 pt-6" style="border-top: 1px solid #363960;">
            <button class="btn-primary" @onclick="LoadFunctions" disabled="@loading">
                @if (loading)
                {
                    <svg class="spinner w-4 h-4 mr-2 -ml-0.5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span>Loading...</span>
                }
                else
                {
                    <svg class="w-4 h-4 mr-2 -ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span>List Functions</span>
                }
            </button>
            <div class="flex items-center gap-3" style="margin-left: auto;">
                <button class="btn-outline-success" @onclick="StartApp" disabled="@loading">Start App</button>
                @if (confirmingStopApp)
                {
                    <div class="confirm-bar-danger">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Stop the entire app?</span>
                        <button class="btn-sm bg-red-600" @onclick="ConfirmStopApp">Stop</button>
                        <button class="btn-sm btn-cancel" @onclick="() => confirmingStopApp = false">Cancel</button>
                    </div>
                }
                else
                {
                    <button class="btn-outline-danger" @onclick="() => confirmingStopApp = true" disabled="@loading">Stop App</button>
                }
            </div>
        </div>
    </div>

    @if (loading)
    {
        <div class="loading-bar">
            <svg class="spinner" style="width: 20px; height: 20px; color: #818cf8;" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Fetching data from Azure...</span>
        </div>
    }

    @if (appStatus is not null)
    {
        <div class="app-status-bar">
            <span style="color: #a5a9c0; font-size: 0.85rem;">Container App</span>
            <strong style="color: #e4e6ed; font-size: 0.85rem;">@appName</strong>
            @if (string.Equals(appStatus, "Running", StringComparison.OrdinalIgnoreCase))
            {
                <span class="status-dot status-dot-green"></span>
                <span class="badge-green">Running</span>
            }
            else if (string.Equals(appStatus, "Stopped", StringComparison.OrdinalIgnoreCase))
            {
                <span class="status-dot status-dot-red"></span>
                <span class="badge-red">Stopped</span>
            }
            else
            {
                <span class="status-dot status-dot-yellow"></span>
                <span class="badge-gray">@appStatus</span>
            }
        </div>
    }

    @if (error is not null)
    {
        <div class="error-box">
            <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div>
                <h4 class="font-bold">Error</h4>
                <p>@error</p>
            </div>
        </div>
    }

    @if (successMessage is not null)
    {
        <div class="success-box">
            <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div>
                <h4 class="font-bold">Success</h4>
                <p>@successMessage</p>
            </div>
        </div>
    }

    @if (results is not null)
    {
        @if (results.Count == 0)
        {
            <div class="empty-state">
                <svg class="w-20 h-20 text-gray-600 mx-auto mb-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                <h3 class="text-xl font-semibold text-gray-300">No functions found.</h3>
                <p class="text-gray-500 mt-2">Try adjusting your search criteria or ensure the container app is running.</p>
            </div>
        }
        else
        {
            <div class="flex items-center gap-3 my-4 text-sm" style="color: #a5a9c0;">
                <span>Found <strong style="color: #d4d7e3;">@results.Count</strong> function(s)</span>
                <span class="badge-blue" style="font-size: 0.8rem;">@activeRevision</span>
            </div>
            <div style="overflow-x: auto; background-color: #272941; border-radius: 12px; border: 1px solid #363960; box-shadow: 0 4px 24px rgba(0,0,0,0.2);">
                <table class="min-w-full">
                    <thead style="background-color: #1e1f33;">
                        <tr>
                            <th class="th" style="width: 140px; text-align: center;">Actions</th>
                            <th class="th">Name</th>
                            <th class="th" style="width: 120px;">Trigger</th>
                            <th class="th" style="width: 100px;">Language</th>
                            <th class="th" style="width: 120px; text-align: center;">Status</th>
                            <th class="th">Invoke URL</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var func in results)
                        {
                            var isDisabled = operationsInProgress.Contains(func.Name);
                            <tr style="border-top: 1px solid #363960; transition: background-color 0.15s; @(isDisabled ? "opacity: 0.4; pointer-events: none;" : "")"
                                onmouseover="this.style.backgroundColor='rgba(99,102,241,0.05)'"
                                onmouseout="this.style.backgroundColor='transparent'">
                                <td class="td actions-cell">
                                    @if (operationsInProgress.Contains(func.Name))
                                    {
                                        <span class="working-text">
                                            <svg class="spinner" style="width: 16px; height: 16px; margin-right: 8px;" fill="none" viewBox="0 0 24 24"><circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                            Applying...
                                        </span>
                                    }
                                    else if (pendingDisable.Contains(func.Name))
                                    {
                                        <span class="badge-red" style="margin-right: 4px;">Will stop</span>
                                        <button class="btn-sm btn-cancel" @onclick="() => CancelPending(func.Name)">Undo</button>
                                    }
                                    else if (pendingEnable.Contains(func.Name))
                                    {
                                        <span class="badge-green" style="margin-right: 4px;">Will start</span>
                                        <button class="btn-sm btn-cancel" @onclick="() => CancelPending(func.Name)">Undo</button>
                                    }
                                    else if (func.Properties.IsDisabled)
                                    {
                                        <button class="btn-sm-outline-success" @onclick="() => QueueEnable(func.Name)">Start</button>
                                    }
                                    else
                                    {
                                        <button class="btn-sm-outline-danger" @onclick="() => QueueDisable(func.Name)">Stop</button>
                                    }
                                </td>
                                <td class="td" style="font-weight: 500;">
                                    <a href="/function/@Uri.EscapeDataString(func.Name)?sub=@Uri.EscapeDataString(subscriptionId)&rg=@Uri.EscapeDataString(resourceGroup)&app=@Uri.EscapeDataString(appName)"
                                       style="color: #818cf8; text-decoration: none; transition: color 0.15s;"
                                       onmouseover="this.style.color='#a5b4fc'; this.style.textDecoration='underline'"
                                       onmouseout="this.style.color='#818cf8'; this.style.textDecoration='none'">
                                        @func.Name
                                    </a>
                                </td>
                                <td class="td"><span class="badge-gray">@func.Properties.TriggerType</span></td>
                                <td class="td">@(func.Properties.Language ?? "N/A")</td>
                                <td class="td" style="text-align: center;">
                                    @if (func.Properties.IsDisabled)
                                    {
                                        <span class="badge-red">Disabled</span>
                                    }
                                    else
                                    {
                                        <span class="badge-green">Active</span>
                                    }
                                </td>
                                <td class="td url-cell">@func.Properties.InvokeUrlTemplate</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (HasPendingChanges)
            {
                <div class="apply-bar">
                    <span style="color: #e4e6ed; font-size: 0.9rem;">
                        @{ var totalPending = pendingDisable.Count + pendingEnable.Count; }
                        <strong>@totalPending</strong> change(s) pending
                        @if (pendingDisable.Count > 0) { <span style="color: #fca5a5;"> &mdash; @pendingDisable.Count to stop</span> }
                        @if (pendingEnable.Count > 0) { <span style="color: #86efac;"> &mdash; @pendingEnable.Count to start</span> }
                    </span>
                    <div class="flex items-center gap-3" style="margin-left: auto;">
                        <button class="btn-sm btn-cancel" @onclick="() => { pendingDisable.Clear(); pendingEnable.Clear(); }">Discard All</button>
                        <button class="btn-primary" style="padding: 7px 18px; font-size: 0.85rem;" @onclick="ApplyChanges" disabled="@applyingChanges">
                            @if (applyingChanges)
                            {
                                <svg class="spinner" style="width: 14px; height: 14px; margin-right: 8px;" fill="none" viewBox="0 0 24 24"><circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span>Applying...</span>
                            }
                            else
                            {
                                <span>Apply Changes</span>
                            }
                        </button>
                    </div>
                </div>
            }
        }
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "sub")] public string? InitSub { get; set; }
    [SupplyParameterFromQuery(Name = "rg")] public string? InitRg { get; set; }
    [SupplyParameterFromQuery(Name = "app")] public string? InitApp { get; set; }

    private string subscriptionId = "";
    private string resourceGroup = "";
    private string appName = "";
    private string? revision;
    private bool loading;
    private string? error;
    private string? successMessage;
    private string activeRevision = "";
    private string? appStatus;
    private List<ContainerAppFunction>? results;
    private bool confirmingStopApp;
    private HashSet<string> pendingDisable = new();
    private HashSet<string> pendingEnable = new();
    private bool applyingChanges;
    private HashSet<string> operationsInProgress = new();

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(InitSub)) subscriptionId = InitSub;
        if (!string.IsNullOrWhiteSpace(InitRg)) resourceGroup = InitRg;
        if (!string.IsNullOrWhiteSpace(InitApp)) appName = InitApp;
    }

    private async Task LoadFunctions()
    {
        if (string.IsNullOrWhiteSpace(subscriptionId) ||
            string.IsNullOrWhiteSpace(resourceGroup) ||
            string.IsNullOrWhiteSpace(appName))
        {
            error = "Subscription ID, Resource Group, and App Name are required.";
            successMessage = null;
            return;
        }

        loading = true;
        error = null;
        successMessage = null;
        results = null;

        try
        {
            var containerApp = await Client.GetContainerAppAsync(subscriptionId, resourceGroup, appName);
            appStatus = containerApp.Properties?.RunningStatus;
            activeRevision = !string.IsNullOrWhiteSpace(revision)
                ? revision
                : containerApp.Properties?.LatestRevisionName ?? "unknown";

            if (string.Equals(appStatus, "Stopped", StringComparison.OrdinalIgnoreCase))
            {
                results = [];
                error = "Container App is stopped. Start the app to list functions.";
            }
            else
            {
                var result = !string.IsNullOrWhiteSpace(revision)
                    ? await Client.ListFunctionsByRevisionAsync(subscriptionId, resourceGroup, appName, revision)
                    : await Client.ListFunctionsAsync(subscriptionId, resourceGroup, appName);

                results = result.Value;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private void QueueDisable(string functionName)
    {
        pendingEnable.Remove(functionName);
        pendingDisable.Add(functionName);
    }

    private void QueueEnable(string functionName)
    {
        pendingDisable.Remove(functionName);
        pendingEnable.Add(functionName);
    }

    private void CancelPending(string functionName)
    {
        pendingDisable.Remove(functionName);
        pendingEnable.Remove(functionName);
    }

    private bool HasPendingChanges => pendingDisable.Count > 0 || pendingEnable.Count > 0;

    private async Task ApplyChanges()
    {
        if (!HasPendingChanges) return;

        var toDisable = pendingDisable.ToList();
        var toEnable = pendingEnable.ToList();

        foreach (var name in toDisable.Concat(toEnable))
            operationsInProgress.Add(name);

        pendingDisable.Clear();
        pendingEnable.Clear();
        applyingChanges = true;
        error = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            if (toDisable.Count > 0)
                await Client.SetFunctionsDisabledAsync(subscriptionId, resourceGroup, appName, toDisable, disabled: true);

            if (toEnable.Count > 0)
                await Client.SetFunctionsDisabledAsync(subscriptionId, resourceGroup, appName, toEnable, disabled: false);

            foreach (var func in results ?? [])
            {
                if (toDisable.Contains(func.Name)) func.Properties.IsDisabled = true;
                if (toEnable.Contains(func.Name)) func.Properties.IsDisabled = false;
            }

            var changedCount = toDisable.Count + toEnable.Count;
            successMessage = $"{changedCount} function(s) updated. A new revision is being created.";
        }
        catch (Exception ex)
        {
            error = $"Failed to apply changes: {ex.Message}";
        }
        finally
        {
            foreach (var name in toDisable.Concat(toEnable))
                operationsInProgress.Remove(name);
            applyingChanges = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmStopApp()
    {
        confirmingStopApp = false;

        if (string.IsNullOrWhiteSpace(subscriptionId) ||
            string.IsNullOrWhiteSpace(resourceGroup) ||
            string.IsNullOrWhiteSpace(appName))
        {
            error = "Subscription ID, Resource Group, and App Name are required.";
            successMessage = null;
            return;
        }

        loading = true;
        error = null;
        successMessage = null;

        try
        {
            await Client.StopContainerAppAsync(subscriptionId, resourceGroup, appName);
            appStatus = "Stopped";
            successMessage = $"Container App '{appName}' is stopping.";
        }
        catch (Exception ex)
        {
            error = $"Failed to stop app: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task StartApp()
    {
        if (string.IsNullOrWhiteSpace(subscriptionId) ||
            string.IsNullOrWhiteSpace(resourceGroup) ||
            string.IsNullOrWhiteSpace(appName))
        {
            error = "Subscription ID, Resource Group, and App Name are required.";
            successMessage = null;
            return;
        }

        loading = true;
        error = null;
        successMessage = null;

        try
        {
            await Client.StartContainerAppAsync(subscriptionId, resourceGroup, appName);
            appStatus = "Running";
            successMessage = $"Container App '{appName}' is starting.";
        }
        catch (Exception ex)
        {
            error = $"Failed to start app: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

}
